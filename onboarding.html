<!DOCTYPE html>
<html>
<head>
    <title>LINE LIFF Authorization Code Flow</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
</head>
<body>
    <h1>LINE LIFF Authorization Code Flow</h1>
    <button onclick="login()">Login and Get Authorization Code</button>
    <pre id="result"></pre>

    <script>
        // Initialize LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: "1657883918-jXRmAqJn" });

                // Check if the user is logged in
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    // User is already logged in
                    const accessToken = liff.getAccessToken();
                    const idToken = liff.getIDToken();

                    // Log the tokens
                    console.log("Access Token:", accessToken);
                    console.log("ID Token:", idToken);

                    // Optional: Send the authorization code and tokens to your backend for further processing
                    // sendAuthCodeToBackend(authCode);
                }
            } catch (error) {
                console.error("LIFF initialization failed:", error);
            }
        }

        // Login and handle the redirect
        function login() {
            const url = window.location.href;

            // Check if the URL contains the authorization code after the redirect
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code'); // Extract the 'code' parameter

            if (authCode) {
                // If the authorization code exists, handle the flow
                handleAuthorizationCode(authCode);
            } else {
                // If no code is present, start the login process
                initializeLiff();
            }
        }

        // Handle the authorization code (exchange it for tokens)
        function handleAuthorizationCode(authCode) {
            console.log("Authorization Code:", authCode);

            // Optional: Send the authorization code to your backend to exchange for tokens
            // Example:
            // fetch('https://your-backend.com/api/exchange-auth-code', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({ code: authCode })
            // })
            // .then(response => response.json())
            // .then(data => {
            //     console.log("Tokens from backend:", data);
            // })
            // .catch(error => {
            //     console.error("Error exchanging authorization code:", error);
            // });
        }
    </script>
</body>
</html>
